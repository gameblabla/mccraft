#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>

#include <eris/v810.h>
#include <eris/king.h>
#include <eris/tetsu.h>
#include <eris/romfont.h>
#include <eris/cd.h>
#include <eris/low/pad.h>
#include <eris/low/scsi.h>

#include "defines.h"

#define SCREEN_BYTES_SIZE SCREEN_GAME_WIDTH*SCREEN_GAME_HEIGHT

unsigned char framebuffer[(SCREEN_GAME_WIDTH*SCREEN_GAME_HEIGHT)];

#define ARRAY_SIZE(arr) (sizeof(arr) / sizeof((arr)[0]))
unsigned short pornpal[256] = {
0x88,0x2778,0x2a79,0x2a77,0x2f78,0x3279,0x3778,0x3c79,
0x4279,0x4679,0x4d79,0x5079,0x4666,0x5179,0x5379,0x5579,
0x4a65,0x5879,0x4e66,0x5979,0x5b79,0x4d65,0x5b79,0x5276,
0x5c79,0x5d79,0x5265,0x5565,0x6269,0x5a65,0x6888,0x5d65,
0x6a88,0x6356,0x6f69,0x6265,0x7269,0x7288,0x7469,0x7669,
0x7769,0x7a88,0x7057,0x7c69,0x7e69,0x8088,0x8288,0x7857,
0x7957,0x8369,0x8a88,0x8057,0x8157,0x8e6a,0x8667,0x7d45,
0x7f44,0x8857,0x8957,0x9369,0x8b56,0x8e67,0x8545,0x9157,
0x8744,0x9057,0x9157,0x9b69,0x8944,0x9e97,0x9667,0x8d45,
0x9957,0x8f44,0x9857,0x9957,0x9c67,0x9144,0x9b56,0x9e67,
0x9545,0x9244,0xa157,0x9744,0xa057,0xa157,0xa467,0xa356,
0xa667,0x9c45,0xa957,0xa857,0x9c44,0xac67,0xa144,0xae67,
0xa244,0xb157,0xa444,0xb467,0xb667,0xaa44,0xac44,0xc497,
0xbe67,0xb244,0xc157,0xb444,0xc467,0xb744,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,
0x4588,0x4588,0x4588,0x4588,0x4588,0x4588,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,
0x6788,0x6788,0x6788,0x6788,0x6788,0x6788,0x38aa,0x3097,
0x598,0x14b8,0x207b,0x12a8,0x3596,0x5268,0x1087,0x1778,
0x6087,0x5b59,0x5358,0xaa8,0x1778,0x15a7,0x5c58,0x1187,

};



int Init_video()
{
	int i;
	u16 microprog[16];
	eris_king_init();
	eris_tetsu_init();
	
	eris_tetsu_set_priorities(0, 0, 1, 0, 0, 0, 0);
	eris_tetsu_set_king_palette(0, 0, 0, 0);
	eris_tetsu_set_rainbow_palette(0);

	eris_king_set_bg_prio(KING_BGPRIO_0, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, 0);
	eris_king_set_bg_mode(KING_BGMODE_256_PAL, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE, KING_BGPRIO_HIDE);
	eris_king_set_kram_pages(0, 0, 0, 0);

	microprog[0] = KING_CODE_BG0_CG_0;
	microprog[1] = KING_CODE_BG0_CG_1;
	microprog[2] = KING_CODE_BG0_CG_2;
	microprog[3] = KING_CODE_BG0_CG_3;

	eris_king_disable_microprogram();
	eris_king_write_microprogram(microprog, 0, 16);
	eris_king_enable_microprogram();
	
	eris_tetsu_set_rainbow_palette(0);
	for(i = 0; i < ARRAY_SIZE(pornpal); i++) {
		eris_tetsu_set_palette(i, pornpal[i]);
	}

	eris_tetsu_set_video_mode(TETSU_LINES_262, 0, TETSU_DOTCLOCK_5MHz, TETSU_COLORS_16, TETSU_COLORS_16, 0, 0, 1, 0, 0, 0, 0);
	eris_king_set_bat_cg_addr(KING_BG0, 0, 0);
	eris_king_set_bat_cg_addr(KING_BG0SUB, 0, 0);
	eris_king_set_scroll(KING_BG0, 0, 0);
	eris_king_set_bg_size(KING_BG0, KING_BGSIZE_256, KING_BGSIZE_256, KING_BGSIZE_256, KING_BGSIZE_256);
	
	eris_king_set_kram_read(0, 1);
	eris_king_set_kram_write(0, 1);
	// Clear BG0's RAM
	for(i = 0x0; i < 256*240; i++) {
		eris_king_kram_write(0x8080);
	}
	
	return 0;
}

void Start_video()
{
}

void Refresh_video()
{
	int i;
	eris_king_set_kram_read(0, 1);
	eris_king_set_kram_write(0, 1);
	for(i = 0x0; i < SCREEN_BYTES_SIZE; i+=2) {
		eris_king_kram_write(framebuffer[i] << 8 | framebuffer[i+1]);
	}
}

void Quit_video()
{
}
